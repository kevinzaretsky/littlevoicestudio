'use client'; #import { useCart } from '@/lib/cart'; #import { cloudThumb } from '@/lib/cloudinaryThumb'; #import { useMemo, useState } from 'react'; function cents(n:number){return(n/100).toFixed(2).replace('.',',')} export default function CartPage(){ const { items, remove } = useCart(); const [checkingOut,setCheckingOut]=useState(false); const total=useMemo(()=> items.reduce((s,i)=> s + i.unitPriceCents*i.qty, 0), [items]); async function checkout(){ setCheckingOut(true); try{ const res=await fetch('/api/checkout',{ method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ items: items.map(i=>({ productSlug:i.productSlug, color:i.color, qty:i.qty, epoxy:i.epoxy==='yes', unitPriceCents:i.unitPriceCents, imagePublicIds:i.imagePublicIds })) }) }); const data=await res.json(); if(data.url) window.location.href=data.url; else alert(data.error??'Checkout failed'); } finally{ setCheckingOut(false); } } return (<div className='grid gap-6'><h1 className='text-2xl font-semibold'>Warenkorb</h1>{items.length===0 ? <p>Dein Warenkorb ist leer.</p> : (<div className='grid gap-4'>{items.map(i=>(<div key={i.id} className='card grid md:grid-cols-4 gap-4'><div className='md:col-span-2'><div className='font-medium'>{i.productSlug}</div><div className='text-sm text-slate-600'>Farbe: {i.color} • Epoxid: {i.epoxy}</div><div className='text-sm text-slate-600'>Menge: {i.qty}</div></div><div className='text-sm text-slate-600'><div>Uploads:</div><ul className='list-disc pl-6'>{i.imagePublicIds.map((pid,idx)=>{ const url=cloudThumb(pid); return (<li key={idx} className='truncate flex items-center gap-2'>{url?<img src={url} alt={pid} width={40} height={40} style={{borderRadius:6}}/>:null}<span className='truncate'>{pid}</span></li>)})}</ul></div><div className='text-right'><div className='font-semibold'>{cents(i.unitPriceCents)} € / Stk.</div><button onClick={()=>remove(i.id)} className='text-sm underline mt-2'>Entfernen</button></div></div>))}<div className='flex items-center justify-between border-t pt-4'><div className='font-semibold'>Gesamt: {cents(total)} €</div><button onClick={checkout} disabled={checkingOut} className='btn'>Zur Kasse</button></div></div>)}</div>); }
