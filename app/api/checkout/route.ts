import { NextRequest, NextResponse } from 'next/server'; import Stripe from 'stripe'; import { prisma } from '@/lib/db'; export const runtime='nodejs'; const stripeSecret=process.env.STRIPE_SECRET_KEY; const stripe = stripeSecret ? new Stripe(stripeSecret, { apiVersion:'2024-06-20' }) : null; type CartItemIn={ productSlug:string;color:string;epoxy:boolean;unitPriceCents:number;qty:number;imagePublicIds:string[] }; function orderNumber(){ return 'LVS-' + Math.random().toString(36).slice(2,7).toUpperCase(); } export async function POST(req: NextRequest){ try{ const body=await req.json(); const items:CartItemIn[]=Array.isArray(body.items)?body.items:[]; if(!items.length) return NextResponse.json({error:'No items.'},{status:400}); if(!stripe) return NextResponse.json({error:'Stripe not configured.'},{status:400}); const order=await prisma.order.create({ data:{ orderNumber:orderNumber(), customerEmail:'pending@checkout', status:'NEW', items:{ create: items.map(i=>({ productSlug:i.productSlug, color:i.color, epoxy:i.epoxy, unitPriceCents:i.unitPriceCents, qty:i.qty, imagePublicIds:i.imagePublicIds })) } }, include:{ items:true } }); const line_items:Stripe.Checkout.SessionCreateParams.LineItem[]=order.items.map(it=>({ quantity:it.qty, price_data:{ currency:'eur', unit_amount:it.unitPriceCents, product_data:{ name:`${it.productSlug} – ${it.color}${it.epoxy?' – Epoxy':''}` } } })); const session=await stripe.checkout.sessions.create({ mode:'payment', currency:'eur', line_items, shipping_address_collection:{ allowed_countries:['DE','AT','CH','BE','NL','LU','FR','ES','IT'] }, metadata:{ orderId:order.id, orderNumber:order.orderNumber }, success_url:(process.env.NEXT_PUBLIC_SITE_URL||'http://localhost:3000')+'/success', cancel_url:(process.env.NEXT_PUBLIC_SITE_URL||'http://localhost:3000')+'/cancel' }); return NextResponse.json({ url: session.url }); } catch(e:any){ return NextResponse.json({error:e.message||'Checkout failed'},{status:500}); } }