import { NextRequest, NextResponse } from 'next/server'; import Stripe from 'stripe'; import { prisma } from '@/lib/db'; export const runtime='nodejs'; export async function POST(req: NextRequest){ const stripeSecret=process.env.STRIPE_SECRET_KEY; const webhookSecret=process.env.STRIPE_WEBHOOK_SECRET; if(!stripeSecret||!webhookSecret){ return NextResponse.json({error:'Stripe not configured'},{status:400}); } const stripe=new Stripe(stripeSecret,{ apiVersion:'2024-06-20' }); const sig=req.headers.get('stripe-signature')||''; const raw=await req.text(); try{ const event=await stripe.webhooks.constructEventAsync(raw,sig,webhookSecret); if(event.type==='checkout.session.completed'){ const session=event.data.object as Stripe.Checkout.Session; const orderId=session.metadata?.orderId; const email=session.customer_details?.email||undefined; const name=session.customer_details?.name||undefined; if(orderId){ const addr=session.shipping_details?.address; const shipName=session.shipping_details?.name||name; let shippingAddressText: string|undefined = undefined; if(addr){ shippingAddressText = `${shipName||''}\n${addr.line1||''} ${addr.line2||''}\n${addr.postal_code||''} ${addr.city||''}\n${addr.country||''}`.trim(); } await prisma.order.update({ where:{ id:orderId }, data:{ status:'PAID', customerEmail: email||'unknown@customer', customerName: shipName||name, shippingAddress: shippingAddressText } }); } } return NextResponse.json({received:true}); }catch(e:any){ return NextResponse.json({error:e.message||'Webhook error'},{status:400}); } }