import { NextRequest } from 'next/server'; import { prisma } from '@/lib/db'; export async function GET(){ const orders=await prisma.order.findMany({ include:{ items:true } }); const rows=[['orderNumber','status','email','name','totalCents','trackingCode','shippedAtISO','items']]; for(const o of orders){ const total=o.items.reduce((s,i)=> s + i.unitPriceCents*i.qty, 0) + (o.shippingPriceCents||0); rows.push([o.orderNumber,o.status,o.customerEmail,o.customerName||'',String(total),o.trackingCode||'',o.shippedAt?o.shippedAt.toISOString():'',o.items.map(i=>`${i.qty}x ${i.productSlug}/${i.color}${i.epoxy?'(epoxy)':''}`).join(' | ')]); } const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n'); return new Response(csv,{ headers:{ 'Content-Type':'text/csv','Content-Disposition':'attachment; filename="orders.csv"' } }); }