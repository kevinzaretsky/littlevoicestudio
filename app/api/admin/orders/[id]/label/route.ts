import { NextRequest } from 'next/server'; import { prisma } from '@/lib/db'; import PDFDocument from 'pdfkit'; import { dhlCreateLabel } from '@/lib/dhl'; export const runtime='nodejs'; function parseAddressBlock(block?: string){ if(!block) return null; const lines=block.split('\n').map(s=>s.trim()).filter(Boolean); if(lines.length<3) return null; const name=lines[0]; const streetLine=lines[1]; const postalCity=lines[2]; const country=(lines[3]||'DE').slice(0,2).toUpperCase(); const m=streetLine.match(/^(.+?)\s+(\S+)$/); const street=m?m[1]:streetLine; const houseNumber=m?m[2]:undefined; const pm=postalCity.match(/^(\S+)\s+(.+)$/); const postal=pm?pm[1]:''; const city=pm?pm[2]:postalCity; return { name, street, houseNumber, postal, city, countryCode:country }; } export async function GET(req: NextRequest, { params }:{ params:{ id:string } }){ const o=await prisma.order.findUnique({ where:{ id: params.id } }); if(!o) return new Response('Not found',{ status:404 }); const receiver=parseAddressBlock(o.shippingAddress||undefined)||{ name:o.customerName||'Empfänger', street:'Musterstraße', houseNumber:'1', postal:'10115', city:'Berlin', countryCode:'DE' }; try{ const out=await dhlCreateLabel({ receiver, reference:o.orderNumber, weightKG:Number(process.env.DHL_DEFAULT_WEIGHT_KG||'1') }); if(out.trackingNumber){ await prisma.order.update({ where:{ id:o.id }, data:{ trackingCode: out.trackingNumber } }); } const buf=Buffer.from(out.labelPdfBase64,'base64'); return new Response(buf,{ headers:{ 'Content-Type':'application/pdf','Content-Disposition':`inline; filename="label-${o.orderNumber}.pdf"` } }); }catch(e:any){ const doc=new PDFDocument({ size:'A6', margin:20 }); const chunks:Uint8Array[]=[]; doc.on('data',c=>chunks.push(c)); const done=new Promise<Buffer>(resolve=>doc.on('end',()=>resolve(Buffer.concat(chunks as any)))); doc.fontSize(12).text('DHL Label Fehler',{ align:'center' }); doc.moveDown(); doc.fontSize(9).text(String(e?.message||e||'unknown error')); doc.end(); const buf=await done; return new Response(buf,{ headers:{ 'Content-Type':'application/pdf' }, status:500 }); } }