import { NextRequest } from 'next/server'; import { prisma } from '@/lib/db'; import PDFDocument from 'pdfkit'; export const runtime='nodejs'; function cents(n:number){return(n/100).toFixed(2).replace('.',',')} export async function GET(req: NextRequest,{ params }:{ params:{ id:string } }){ const o=await prisma.order.findUnique({ where:{ id: params.id }, include:{ items:true } }); if(!o) return new Response('Not found',{ status:404 }); const total=o.items.reduce((s,i)=> s + i.unitPriceCents*i.qty, 0) + (o.shippingPriceCents||0); const doc=new PDFDocument({ size:'A4', margin:50 }); const chunks:Uint8Array[]=[]; doc.on('data',(c)=>chunks.push(c)); const done=new Promise<Buffer>((resolve)=>doc.on('end',()=>resolve(Buffer.concat(chunks as any)))); doc.fontSize(20).text('Rechnung',{ align:'right' }); doc.fontSize(12).text(`Bestellnummer: ${o.orderNumber}`); doc.moveDown(); doc.text(`Datum: ${new Date(o.createdAt).toLocaleDateString('de-DE')}`); doc.moveDown(); doc.text('Positionen:'); doc.moveDown(0.5); o.items.forEach(i=>{ doc.text(`${i.qty} × ${i.productSlug} – ${i.color}${i.epoxy?' – Epoxy':''}  @ ${cents(i.unitPriceCents)} €`); }); doc.moveDown(); doc.text(`Versand: ${cents(o.shippingPriceCents||0)} €`); doc.moveDown(); doc.fontSize(14).text(`Gesamt: ${cents(total)} €`,{ align:'right' }); doc.end(); const buf=await done; return new Response(buf,{ headers:{ 'Content-Type':'application/pdf','Content-Disposition':`inline; filename="invoice-${o.orderNumber}.pdf"` } }); }