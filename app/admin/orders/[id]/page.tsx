import { prisma } from '@/lib/db'; import Link from 'next/link'; import { cloudThumb } from '@/lib/cloudinaryThumb'; function cents(n:number){return(n/100).toFixed(2).replace('.',',')} export default async function OrderDetail({ params }:{ params:{ id:string } }){ const o=await prisma.order.findUnique({ where:{ id: params.id }, include:{ items:true } }); if(!o) return <div>Nicht gefunden</div>; const total=o.items.reduce((s,i)=> s + i.unitPriceCents*i.qty, 0) + (o.shippingPriceCents||0); return (<div className='grid gap-4'><div className='flex items-center justify-between'><h1 className='text-2xl font-semibold'>Bestellung {o.orderNumber}</h1><div className='flex gap-2'><a className='btn secondary' href={`/api/admin/orders/${o.id}/invoice`}>Rechnung (PDF)</a></div></div><div className='card grid gap-2'><div>Status: <strong>{o.status}</strong></div><form action={`/api/admin/orders/${o.id}/status`} method='POST' className='flex gap-2 items-end'><div><label>Neuer Status</label><select name='status'><option>NEW</option><option>PAID</option><option>FULFILLING</option><option>SHIPPED</option><option>CANCELED</option></select></div><button className='btn' type='submit'>Ändern</button></form></div><div className='card'><table className='table'><thead><tr><th>Produkt</th><th>Farbe</th><th>Epoxy</th><th>Menge</th><th>Preis + Uploads</th></tr></thead><tbody>{o.items.map(i=>(<tr key={i.id}><td>{i.productSlug}</td><td>{i.color}</td><td>{i.epoxy?'Ja':'Nein'}</td><td>{i.qty}</td><td>{cents(i.unitPriceCents)} €<div className='mt-2 flex gap-2 flex-wrap'>{i.imagePublicIds.map((pid:any,idx:number)=>{ const url=cloudThumb(pid); return url ? <img key={idx} src={url} alt={pid} width={48} height={48} style={{borderRadius:6}}/> : <span key={idx} className='text-xs'>{pid}</span> })}</div></td></tr>))}</tbody></table></div><div className='card'>Summe: <strong>{cents(total)} €</strong></div><div className='card grid gap-2'><form action={`/api/admin/orders/${o.id}/tracking`} method='POST' className='grid sm:grid-cols-3 gap-2 items-end'><div><label>Tracking Code (DHL)</label><input name='trackingCode' defaultValue={o.trackingCode || ''} placeholder='00340434...' /></div><button className='btn' type='submit'>Speichern</button><a className='btn secondary' href={`/api/admin/orders/${o.id}/label`}>Versandlabel (PDF)</a></form><form action={`/api/admin/orders/${o.id}/ship`} method='POST'><button className='btn mt-2'>Als versendet markieren</button></form></div><Link href='/admin/orders' className='text-sm underline'>Zurück</Link></div>); }